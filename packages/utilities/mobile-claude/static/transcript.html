<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Claude Transcripts</title>
    <script type="module" src="https://cdn.jsdelivr.net/gh/starfederation/datastar@1.0.0-RC.7/bundles/datastar.js"></script>
    <style>
        * { box-sizing: border-box; margin: 0; padding: 0; }
        html, body {
            font-family: -apple-system, BlinkMacSystemFont, sans-serif;
            background: #1a1a2e;
            color: #eee;
            height: 100%;
            height: 100dvh;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }
        header {
            padding: 12px;
            background: #16213e;
            flex-shrink: 0;
            z-index: 10;
        }
        h1 {
            font-size: 18px;
            margin-bottom: 8px;
            color: #fff;
        }
        .controls {
            display: flex;
            gap: 8px;
            align-items: center;
            flex-wrap: wrap;
        }
        select {
            flex: 1;
            min-width: 200px;
            padding: 8px 12px;
            border: none;
            border-radius: 6px;
            background: #0f3460;
            color: #fff;
            font-size: 14px;
            appearance: none;
            -webkit-appearance: none;
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='12' fill='%23fff'%3E%3Cpath d='M6 8L1 3h10z'/%3E%3C/svg%3E");
            background-repeat: no-repeat;
            background-position: right 12px center;
            cursor: pointer;
        }
        button {
            padding: 8px 16px;
            border: none;
            border-radius: 6px;
            background: #0f3460;
            color: #fff;
            font-size: 14px;
            cursor: pointer;
            white-space: nowrap;
        }
        button:hover {
            background: #1a4a8a;
        }
        button.active {
            background: #10b981;
        }
        #container {
            flex: 1;
            overflow-y: auto;
            -webkit-overflow-scrolling: touch;
            padding: 12px;
        }
        #messages {
            max-width: 900px;
            margin: 0 auto;
            overflow: hidden;
        }
        #messages > div {
            overflow: hidden;
        }
        #messages div[style*="monospace"] {
            overflow-wrap: break-word;
            word-break: break-all;
            white-space: pre-wrap;
        }
        #messages:empty::before {
            content: 'Select a session to view transcript...';
            display: block;
            text-align: center;
            color: #666;
            padding: 40px 20px;
            font-size: 14px;
        }
        .status {
            font-size: 12px;
            color: #888;
            margin-top: 8px;
        }
        .loading {
            text-align: center;
            padding: 20px;
            color: #666;
        }
    </style>
</head>
<body>
    <header>
        <h1>Claude Transcripts</h1>
        <div class="controls">
            <input type="text" id="filterInput" placeholder="Filter sessions..." style="flex:1;min-width:200px;padding:8px 12px;border:none;border-radius:6px;background:#0f3460;color:#fff;font-size:14px;">
            <select id="sessionSelect">
                <option value="">Loading sessions...</option>
            </select>
            <button id="autoScrollBtn" class="active">
                Auto-scroll: <span>ON</span>
            </button>
            <button id="rawModeBtn">
                Raw: <span>OFF</span>
            </button>
        </div>
        <div class="status" id="status">No session selected</div>
    </header>

    <div id="container">
        <div id="messages"></div>
    </div>

    <script>
        let autoScroll = true;
        let rawMode = false;
        let eventSource = null;
        let currentSession = null;

        const container = document.getElementById('container');
        const messages = document.getElementById('messages');
        const select = document.getElementById('sessionSelect');
        const autoScrollBtn = document.getElementById('autoScrollBtn');
        const rawModeBtn = document.getElementById('rawModeBtn');
        const status = document.getElementById('status');

        // Load sessions on page load
        document.addEventListener('DOMContentLoaded', async () => {
            try {
                const res = await fetch('/api/transcripts');
                const data = await res.json();
                select.innerHTML = '<option value="">Select a session...</option>';
                data.transcripts.forEach(t => {
                    const opt = document.createElement('option');
                    opt.value = t.path;
                    const d = new Date(t.mtime * 1000);
                    const dt = d.toLocaleDateString('en-GB', {day:'2-digit',month:'short',year:'numeric'}) + ' ' + d.toLocaleTimeString('en-GB', {hour:'2-digit',minute:'2-digit'});
                    const proj = t.project ? t.project + ' | ' : '';
                    const shortName = t.name.split('/').pop().replace('.jsonl','').slice(0,20);
                    opt.textContent = proj + dt + ' | ' + shortName;
                    select.appendChild(opt);
                    allOptions.push({value: t.path, text: opt.textContent});
                });
            // Auto-select from URL param
                const params = new URLSearchParams(window.location.search);
                const sessionParam = params.get('session');
                if (sessionParam) {
                    // Try to select it in dropdown
                    const opts = select.querySelectorAll('option');
                    for (const opt of opts) {
                        if (opt.value === sessionParam) {
                            opt.selected = true;
                            break;
                        }
                    }
                    connectToSession(sessionParam);
                }
            } catch (e) {
                console.error('Failed to load sessions:', e);
            }
        });

        // Connect to session stream
        function connectToSession(session) {
            if (eventSource) {
                eventSource.close();
                eventSource = null;
            }
            messages.innerHTML = '';
            currentSession = session;

            if (!session) {
                status.textContent = 'No session selected';
                return;
            }

            status.textContent = 'Connecting...';
            const url = '/stream?session=' + encodeURIComponent(session) + (rawMode ? '&raw=1' : '');
            eventSource = new EventSource(url);

            eventSource.addEventListener('datastar-patch-elements', (e) => {
                // Data format: "elements <html>"
                const html = e.data.replace(/^elements\s+/, '');
                const temp = document.createElement('div');
                temp.innerHTML = html;
                while (temp.firstChild) {
                    messages.appendChild(temp.firstChild);
                }
                if (autoScroll) {
                    container.scrollTop = container.scrollHeight;
                }
            });

            eventSource.onopen = () => {
                status.textContent = (rawMode ? '[RAW] ' : '') + 'Watching: ' + session.split('/').pop();
                // If goto param, disable auto-scroll and scroll to timestamp after delay
                const gotoTs = new URLSearchParams(window.location.search).get('goto');
                if (gotoTs) {
                    autoScroll = false;
                    autoScrollBtn.textContent = 'Auto-scroll: OFF';
                    autoScrollBtn.classList.remove('active');
                    setTimeout(() => {
                        for (const d of messages.children) {
                            if (d.textContent.includes(gotoTs)) {
                                d.scrollIntoView({block: 'start'});
                                d.style.outline = '3px solid #f59e0b';
                                break;
                            }
                        }
                    }, 3000);
                }
            };

            eventSource.onerror = () => {
                status.textContent = 'Connection error - retrying...';
            };
        }

        // Filter sessions
        const filterInput = document.getElementById('filterInput');
        let allOptions = [];
        filterInput.addEventListener('input', () => {
            const q = filterInput.value.toLowerCase();
            select.innerHTML = '<option value="">Select a session...</option>';
            allOptions.filter(o => o.text.toLowerCase().includes(q)).forEach(o => {
                const opt = document.createElement('option');
                opt.value = o.value;
                opt.textContent = o.text;
                select.appendChild(opt);
            });
        });

        // Handle session selection
        select.addEventListener('change', () => connectToSession(select.value));

        // Toggle auto-scroll
        autoScrollBtn.addEventListener('click', () => {
            autoScroll = !autoScroll;
            autoScrollBtn.classList.toggle('active', autoScroll);
            autoScrollBtn.querySelector('span').textContent = autoScroll ? 'ON' : 'OFF';
            if (autoScroll) {
                container.scrollTop = container.scrollHeight;
            }
        });

        // Toggle raw mode
        rawModeBtn.addEventListener('click', () => {
            rawMode = !rawMode;
            rawModeBtn.classList.toggle('active', rawMode);
            rawModeBtn.querySelector('span').textContent = rawMode ? 'ON' : 'OFF';
            // Reconnect with new mode
            if (currentSession) {
                connectToSession(currentSession);
            }
        });
    </script>
</body>
</html>
